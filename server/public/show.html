<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title></title>
  <link rel="stylesheet" src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" src="stylesheets/app.css">
</head>
<body>
  <div id="app"></div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.10.0/react.min.js"></script>
  <script>
    var Timeline = React.createClass({
      render: function () {
        return React.DOM.div({}, '');
      }
    });

    var Player = React.createClass({
      render: function () {
        if (this.props.src) {
          return React.DOM.video({
            src: this.props.src,
            controls: true
          });
        } else {
          return React.DOM.div({}, 'Waiting...');
        }
      }
    });

    var App = React.createClass({
      getInitialState: function () {
        return {conference: {}};
      },
      componentDidMount: function () {
        var query = window.location.search.substr(1);
        var pairs = query.split('&').map(function (part) {
          return part.split('=');
        });

        var params = pairs.reduce(function (params, pair) {
          var key = pair[0], value = pair[1];
          if (!params[key]) params[key] = [];
          params[key].push(value);
          return params;
        }, {});

        var id = params.cid[0];

        $.get('/api/conferences/' + id + '.json', function (conference) {
          var action;

          if (conference.src) {
            this.setState({conference: conference});
          } else {
            action = '/api/conferences/' + conference.id + '/actions/mix.json';
            $.post(action, function (conference) {
              this.setState({conference: conference});
            }.bind(this));
          }
        }.bind(this));
      },
      render: function () {
        return React.DOM.div({}, [
          React.DOM.h2({}, 'Show'),
          Player({src: this.state.conference.src})
        ]);
      }
    });

    React.renderComponent(App({}), document.getElementById('app'));
  </script>
</body>
